---
description: EverQuest Emulator Server code changes for year 2016
---

# 2014

## 12/30/2014

* **Trevius** \(RoF2\) Aug Type 21 no longer shows the "Buy Now" button in the aug slot of items.
* **Trevius** \(RoF2\) Identified the "Copied" item flag with the help of Uleat.

## 12/29/2014

* **Trevius** \(RoF2\) Identified a few Item Fields and resolved an issue with cloth armor not accepting certain augments that they should.
* **Akkadius** Updated $client-&gt;UpdateTaskActivity to have optional argument ignore\_quest\_update IE: Client::UpdateTaskActivity\(THIS, TaskID, ActivityID, Count, \[ignore\_quest\_update\]\)
* **Akkadius** Also updated internal UpdateTaskActivity methods to optionally ignore quest based task updates to prevent feedback

## 12/28/2014

* **Uleat** Implemented class Client::TextLink as a replacement for the dozens of individual link formatters.

## 12/27/2014

* **Akkadius** Add option to automatic database upgrade script 5\) Download latest Opcodes from Github
* **Trevius** \(RoF2\) Fixed dropping items on the ground so they go to ground level instead of camera height.
* **Trevius** Show Helm Option should be functional again.
* **Kayen** Implemented npc special ability \(43\) CASTING\_RESIST\_DIFF which sets innate resist modifier on ALL spells used by that NPC. Ie. 43,1,-200 will set a -200 innate resist diff, so if your npc cast

  a spell that has a -10 resist modifier the final resist diff would be -210.

## 12/25/2014

* **Uleat** Updated 'links' code for all clients

## 12/24/2014

* **Trevius** \(RoF+\) Added herosforgemodel field to the npc\_types table.
* **Trevius** \(RoF2\) Updated item links from \#npcstat command output.
* **Trevius** \(RoF+\) Implemented Hero's Forge Armor for NPCs.  Set the herosforgemodel field in npc\_types table to the model \(example: 84 for full set, or 12107 for robe\).
* **Trevius** \(RoF+\) Hero's Forge Armor now overrides NPC texture settings.  To display Hero's Forge Armor Helms, set helmtexture field to anything other than 0.

## 12/23/2014

* **Uleat** Tidied up some ItemInst\* declarations and added some nullptr checks.
* **Trevius** \(RoF+\) Added support for Hero's Forge Robe Models.  Set herosforgemodel field in items table to exact model such as 11607, 11707, etc.

## 12/22/2014

* **Trevius** \(RoF2\) Fixed Tracking.
* **Trevius** \(RoF+\) Added a work-around for the cursor buffer issue.

## 12/21/2014

* **Trevius** \(RoF2\) Fixed Extended Targets Window by correcting opcodes.
* **Trevius** \(RoF/RoF2\) Fixed Guild Rank in the Player Profile, which prevents the guild rank message on login/zone.

## 12/20/2014

* **Akkadius** Updated \#cvs to display RoF2 Client Stream count

## 12/19/2014

* **Trevius** \(RoF2\) Fixed Leadership AA Purchasing and Recipe Search by correcting opcodes.
* **Trevius** Fixed Armor Tinting \(players and NPCs\) that was broken during a previous update.
* **Trevius** \(RoF2\) Fixed Rest Timer, Show Helm Option, Auto-Consent Options, and identified Krono in the PP.
* **Trevius** Fixed Selling for Alternate Currency Merchants for RoF and RoF2.

## 12/18/2014

* **Trevius** Finished lining up the RoF2 Player Profile Struct.  Zone times are now normal, and everything from the PP is accurate in game now.
* **Trevius** Fixed zoning after death for RoF2.

## 12/17/2014

* **mackal** Use vectors for route stuff, should be more CPU cache friendly so faster
* **Secrets** EQStream changes as recommended by a community member in private.

## 12/15/2014

* **Trevius** \(RoF+\) Implemented the 6th Augment Slot for Items.
* **Trevius** Player Corpses now saved attuned settings for Items.

{% hint style="info" %}
**Required SQL** utils/sql/git/required/2014\_12\_15\_multiple\_table\_updates.sql
{% endhint %}

## 12/13/2014

* **mackal** Fix guild rank spam on zone \(needed to be in OP\_PP\).
* **Trevius** \(RoF+\) Implemented Armor Ornamentation using Hero's Forge Armor Models.  To use, create an ornamentation augment and set the herosforgemodel field in the items table.
* **Trevius** \(RoF+\) Added command \#heromodel \(\#hm for short\) \* Usage: \#heromodel \[hero forge model\] \[ \[slot\] \] \(example: \#heromodel 63\)

{% hint style="info" %}
**Required SQL** utils/sql/git/required/2014\_12\_13\_inventory\_table\_update.sql
{% endhint %}

## 12/12/2014

* **mackal** Add special attack 42, Ignore Root Aggro Rules. This allows you to root a mob and have them still use the normal aggro rules \(so they will attack the one with most hate, not closest\)

## 12/09/2014

* **Trevius** \(RoF+\) Implemented Hero's Forge Armor Models for Items.  To use, set herosforgemodel field in the item table to a model number such as 63 \(for example\).
* **mackal** SoF+ swarm pets will no longer be F8able \(without a hack!\)

## 12/08/2014

* **Secrets** Added a feature that allows an EQ client to log in directly to World without having to enter the LoginServer, provided the 'password' field is set in WorldServer.

## 12/04/2014

* **Kayen** Ranged attacks will now more accurately check MAX firing range, fixing the issue where you would

  hit ranged attack and nothing would happpen due to incorrect server side range checks.

* **Trevius** Initial addition of the RoF2 client from May 10th 2013 \(currently available on Steam as the F2P client\).
* **Trevius** RoF2 is disabled by default, but you can enable by editing /common/patches/patches.cpp \(see comments\)

## 12/01/2014

* **Trevius** Mercenaries now spawn as the same Gender and Size of the Merchant they are purchased from.
* **Trevius** Mercenaries now spawn with randomized facial features when purchased.
* **Trevius** Setting a lastname for NPCs will now override any hard coded lastname \(such as GM Trainers\).

{% hint style="info" %}
**Required SQL** utils/sql/git/required/2014\_12\_01\_mercs\_table\_update.sql
{% endhint %}

## 11/28/2014

* **Trevius** Fixed a zone crash related to numhits for spells.
* **Trevius** Fixed a query related to group leaders logging in.

  Trevius \(Natedog\): Fixed a world crash related to attempting to join an adventure with Mercenaries.

## 11/27/2014

* **Kayen** Projectiles \(ie Arrows\) fired from archery will now do damage upon impact instead of instantly \(consistent w/ live\).

{% hint style="info" %}
**Optional SQL** utils/sql/git/optional/2014\_11\_27\_ProjectileDmgOnImpact.sql
{% endhint %}

## 11/25/2014

* **Trevius** Spells that modify model size are now limited to 2 size adjustments from the base size.
* **Trevius** Fix to prevent Mercenaries from being set as Group Leader.

## 11/24/2014

* **Trevius** Added Rule NPC:EnableMeritBasedFaction \(disabled by default\) \* Allows faction gain to work similar to experience.

## 11/22/2014

* **Trevius** Grouping with Mercenaries is now considerably less buggy.
* **Trevius** Fixed an issue with Spell Globals related to high Character IDs.
* **Trevius** Crash fix for Swarm Pets.

## 11/19/2014

* **Trevius** Mercenaries now Dismiss, Suspend, Unsuspend, and Die correctly.

## 11/18/2014

* **Trevius** Mercenaries can now zone once again.

## 11/17/2014

* **mackal** Correct OP\_AugmentInfo reply. This fixes RoF display issue with Adventurer's Stone. Still issues with UF/SoF/SoD though.

## 11/16/2014

* **mackal** fix size issue with ControlBoat\_Struct and exploit fix in OP\_BoardBoat
* **Akkadius** Implemented Automatic Database update and versioning system
* **Akkadius** Created database revision define, this is located in version.h in common \#define CURRENT\_BINARY\_DATABASE\_VERSION 9057
  * This revision define will need to be incremented each time a database update is made
  * Along with a revision define increment, you will need to update the db\_update manifest located in:
    * [https://raw.githubusercontent.com/EQEmu/Server/master/utils/sql/db\_update\_manifest.txt](https://raw.githubusercontent.com/EQEmu/Server/master/utils/sql/db_update_manifest.txt)
    * An entry needs to be made at the bottom of the manifest, the entry is quite simple
    * Example: 9057\|2014\_11\_13\_spells\_new\_updates.sql\|SHOW COLUMNS FROM `spells_new` LIKE 'disallow\_sit'\|empty\|
      * This latest example is checking to see if the spells\_new table contains the column 'disallow\_sit', if its empty, the update needs to be ran
        * More examples of match types below:

          Example: Version\|Filename.sql\|Query\_to\_Check\_Condition\_For\_Needed\_Update\|match type\|text to match

          0 = Database Version

          1 = Filename.sql

          2 = Query\_to\_Check\_Condition\_For\_Needed\_Update

          3 = Match Type \* If condition from match type to Value 4 is true, update will flag for needing to be ran

          contains = If query results contains text from 4th value

          match = If query results matches text from 4th value

          missing = If query result is missing text from 4th value

          empty = If the query results in no results

          not\_empty = If the query is not empty

          4 = Text to match
  * The manifest contains all database updates 'Required' to be made to the schema, and it will contain a working backport all the way back to SVN -

      currently it is tested and backported through the beginning of our Github repo

  * On world bootup or standalone run of db\_update.pl, users will be prompted with a simple menu that we will expand upon later:

## 11/15/2014

* **Uleat \(Natedog\)** A better fix for OP\_ShopPlayerBuy \* doesn't cause the issues that I introduced
* **Kayen** Implemented NPC Special Ability 41 'Allow To Tank', gives NPC opportunity to take aggro over a client in melee range.
* **Kayen** Updated swarm pet AI to be consistent with live.

### Old AI

Swarm pet would lock on to target until target died, then depop as soon as target died.

### New AI

Swarm pet will attack cast on target, NOT perma locked it can change targets if attacked by something else that generate more hate. When target dies swarm pet will follow owner, if owner is attacked by something else the swarm pet will attack it \(until duration timer despawns the pet\).

* **Kayen** Updated perl quest function: MakeTempPet\(Tspell\_id, name=nullptr, duration=0, target=nullptr, sticktarg=0\)
* **Kayen** Implemented perl quest function:  Mob::TypesTempPet\(npctypesid, name=nullptr, duration=0, follow=0, target=nullptr, sticktarg=0\)

  Note: 'sticktarg' field will cause the swarm pet to use the OLD AI

Rule to use OLD AI only \* default is disabled

{% hint style="info" %}
**Optional SQL** utils/sql/git/optional/2014\_11\_15\_SwarmPetTargetLock.sql
{% endhint %}

## 11/14/2014

* **Secrets** Identified object size and solidtype as flags. Exported them as functions to Perl.
* **mackal** Don't use the hack for charms that doesn't work on RoF
* **mackal** UF too
* **mackal** Tit
* **mackal** SoF
* **mackal** SoD
* **mackal** 62 \(untested\)

## 11/13/2014

* **Kayen** Implemented target type \(44\) 'Beams' \(which projects an AE infront of caster with a specified length and width\).
* **Kayen** Implemented target type \(32\) AE Target HateList
* **Kayen** Implemented target type \(36\) Area Client Only
* **Kayen** Implemented target type \(37\) Area PC Only
* **Kayen** Implemented target type \(39\) Group No Pet
* **Uleat** PlayerLogMerchantTransactions does not support partial stack purchase logging at this time

## 11/12/2014

* **Uleat** Changed 'GMTrainee' struct to reflect the actual client hard-coded max skill count \(100\) \* applies to all currently supported clients \(6.2-&gt;RoF\)

## 11/11/2014

* **Uleat** Third attempt at a fix for GM trainer zone crashes... \(this is starting to look like a KLS fix...\)

## 11/10/2014

* **Uleat** Fix for GM Trainer crashing server \(really!\)
* **JJ** Yellow faction messages.

## 11/09/2014

* **Kayen** Implemented support for spell target type \(45\) 'Target Rings' on Underfoot \(does work earlier expansions\). Thanks to Lecht for figuring out the op\_code side.
* **JJ** Implement new Live-like faction adjustment message using rule Client:UseLiveFactionMessage.

  Optional SQL: utils/sql/git/optional/2014\_11\_09\_LiveFactionMessages.sql

## 11/06/2014

* **mackal** Tracking default sort will now be correct order
* **Trevius** Fixed dynamic merchant list loading.  Allows any merchant to be used in any zone.

## 11/03/2014

* **Secrets** Fixed an overflow in melee lifetap calculations \(int16 vs int32\)
* **Secrets** Fixed overflow on AC and ATK values that can go out of range.
* **Secrets** Merc/Bot fixes for previous updates.
* **Secrets** Changed a lot of int16s for stat-related functions to int32 because they were causing combat formula overflows \(int16/int32 mismatch\).
* **Secrets** Linux fix?

## 11/02/2014

* **Akkadius** Added out of range checking for Spell Save/Loads

## 11/01/2014

* **Trevius** Fixed potential crash related to Pets/Mercs buffs when targeting themselves.
* **JJ** \(noudess\) Revamped faction system. See [https://github.com/EQEmu/Server/pull/256](https://github.com/EQEmu/Server/pull/256)

## 10/28/2014

* **Uleat** Added Client::InterrogateInventory\(\). Can be invoked by \#interrogateinv and is also called when Handle\_OP\_MoveItem\(\) calls for SwapItemResync\(\)

## 10/22/2014

* **Uleat** Fix for stacking items in a world object..added a new command option: \#peekinv world \* will show world container contents, if one is in use by target.

## 10/20/2014

* **mackal** Inspect Buffs rank 1 will now show NPC buffs in target window \(SoD+\)

## 10/19/2014

* **Uleat** Updated command \#peekinv to display item links properly in RoF clients
* **mackal** Group Mentoring in raids
* **mackal** Inspect Buffs \(text only version\) works in raid groups
* **mackal** Make use of the Inspect Buffs op/packet. 62 SOL until someone finds its op

## 10/18/2014

* **mackal** Implement group mentor, sharing leadership exp \(SoF+ only\)
* **mackal** Add gaining of group leadership while in raids

## 10/16/2014

* **Uleat** Fixed the auto-conversion view naming error and renamed the views in the script files. Added a fix sql for databases that auto-converted.

  Fix SQL: ../sql/git/bots/deprecated/2014\_10\_16\_Lower\_Case\_View\_Fix.sql

## 10/15/2014

* **Uleat** Cleaned up load/drop bots sqls, added '../utils/sql/git/bots/deprecated' and '../deprecated/load\_bots\_old.sql' \(use this file on pre-player blob conversion databases.\)

  Notes: I modifed the behavior of both load and drop bots to fail on the first operation if their modifications have been performed already.

  ```text
   'load_bots.sql' will explicitly add bot schema, while 'drop_bots.sql' will explicitly drop it. I also added a few lines to change
   a few altered tables back to their original state * as of the date in the file.
  ```

## 10/13/2014

* **mackal** Partially implement leadership and raids
  * Currently working: client side only effects and stat bonuses
  * Not working: Mark NPC, and other stuff that need extra server side support
  * Currently only UF tested \(Tit and 62 may just work, others need packet work\)

## 10/12/2014

* **Akkadius** Fix for LDON Character Stat load

## 10/11/2014

* **mackal** Implement Raid MOTD for UF

    Don't forget 2014\_10\_11\_RaidMOTD.sql!

## 10/09/2014

* **Uleat** Added 'BOTS' conversion code to supplement the database 'PlayerProfile' blob conversion that Akkadius recently implemented

## 10/07/2014

* **mackal** Identified tutorial flag in all charcreate packets, reworked logic to correctly set homes binds

## 10/05/2014

* **Uleat** Added Server&lt;-&gt;Corpse slot translators needed for re-enumeration \(inactive until phased in\)

## 10/03/2014

* **Uleat** Fixed Ti\(6.2\) OP\_AugmentInfo translation that I broke \(does not currently need and I mis-read a process\)
* **Uleat** Moved client patch OP\_LootItem slot translation to external handlers

## 10/02/2014

* **Kayen** Exported to PERL $client-&gt;SendSpellAnim\(targetid, spellid\)

  This function sends the spell graphic of a spell without actually having to cast the spell.

## 10/02/2014

* **Uleat** First round of Ti/6.2 translators added \* needed for re-enumeration

## 10/01/2014

* **Kayen** Exported to PERL $client-&gt;SendColoredText\(color, msg\)
* **mackal** Exported SendColoredText to lua

## 09/30/2014

* **Uleat** Implemented click-casting from bag slots for clients that natively support it \(RoF\)

## 09/28/2014

* **mackal** Add support for post June 18, 2014 Hundred Hands Effect spells \(they changed the formula and stuff\)

  set Spells:Jun182014HundredHandsRevamp to true if you're using a spell file from June 18, 2014+

## 09/27/2014

* **Kayen** Implemented perl function $mob-&gt;GetSpellStat\(spell\_id, identifier, slot\);

  Note: identifier is the stat field in spells\_new, slot is used for certain effects like effectid, base,base2, max ect.

  Example $mob-&gt;GetSpellStat\(121, "range"\); //Returns spell range

  Example $mob-&gt;GetSpellStat\(121, "effectid", 1\); //Returns the the value of effectid1

  This will allow you to pull almost all the data for any spell in quest files.

* **mackal** Move the client's SetAttackTimer to the end of Client::CalcBonuses to keep the haste in sync
* **mackal** Correct haste/slow "stacking" rules
* **mackal** Correct SE\_AttackSpeed4 to respect unslowable
* **mackal** Make the haste be between 1-225 like the client \(100 = haste\) to ...
* **mackal** Correct Hundred Hands effect and use formula provided by devs

## 09/24/2014

* **Uleat** Re-ordered server opcodes and handlers to give them some predictability of location \(I need this for the inventory re-enumeration.\)
* **mackal** Added helper function bool EQEmu::IsTradeskill\(uint32 skill\)

## 09/23/2014

* **Kayen** Spell recourse effects will now be applied AFTER the base spells effects have been applied \(consistent with live\).
* **Kayen** SE\_ApplySpell and SE\_TriggerSpell will now be applied based on which effect slot they are used in \(instead of always before all spell effects are checked\).

  Note: If a spell has multiple SE\_TriggerSpell effects within it. Only one will be able to trigger. \(If you want multiple spells use SE\_ApplySpell\)

## 09/22/2014

* **Akkadius** \#resetaa now covers the function of \#resetaa and \#refundaa
  * **resetaa will wipe all AA data, refund the spent points into the available points and send character to character select properly**
* **Akkadius** Removed \#refundaa
* **Akkadius** Removed a lot of debug code for blob conversion
* **Akkadius** Changed status logging for loads/saves to Debug category

## 09/21/2014

* **Akkadius** Player Profile Blob to Database Conversion
  * Summary: HUGE difference in database speeds reads/writes and 1:10 datasize difference
    * The new character storage engine unlike the character\_ table before, is able to properly index data and make use of

        proper MySQL/MariaDB caching optimizations and performance has increased phenominally

      PERFORMANCE AND STATISTICS FIGURES \(Varies on hardware\):

    * EZ Server Character data size of 2.6GB `character_` table alone now takes up approx 600MB
    * Character Data Loads take approx .03 seconds BEFORE MySQL/MariaDB cache
    * Character Data Loads take approx .001-.0035 seconds AFTER MySQL/MariaDB cache
    * Character Data Saves take approx .0001 \* .003 for any particular save operation
    * Database Auto Conversion: When the 'character\_' table exists, World boot-up will queue an auto-conversion prompt and convert all of your characters, BACKUP

        YOUR DATABASE BEFORE CONVERTING, here is an EASY backup script: [http://wiki.eqemulator.org/p?MySQL\_DB\_Backup\_Script](http://wiki.eqemulator.org/p?MySQL_DB_Backup_Script)

      * On auto conversion, the following tables are created automatically:
        * Table: `character_skills` \* Stores Character Skills
        * Table: `character_languages` \* Stores Character Language
        * Table: `character_bind` \* Stores Character Bind point and Home Bind point designated by is\_home bool field
        * Table: `character_alternate_abilities` \* Stores all Character AA
        * Table: `character_currency` \* Stores all Platinum/Gold/Silver/Copper and character related currencies
        * Table: `character_data` \* Stores basic character data \(Fields from `character_` table migrated to this table\)
        * Table: `character_spells` \* Stores character spells
        * Table: `character_memmed_spells` \* Stores character memorized spells
        * Table: `character_disciplines` \* Stores character disciplines
        * Table: `character_material` \* Stores character armor dye textures
        * Table: `character_tribute` \* Stores character tributes
        * Table: `character_bandolier` \* Stores character bandoliers
        * Table: `character_inspect_messages` \* Stores character inspection messages \(Moved from `character_` table\)
        * Table: `character_leadership_abilities` \* Stores character Leadership AAs
  * Loads: Majority of Player profile loads now occur at Client::Handle\_Connect\_OP\_ZoneEntry

      LoadCharacterFactionValues\(uint32 character\_id, faction\_map & val\_list\);

      LoadCharacterSpellBook\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterMemmedSpells\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterLanguages\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterDisciplines\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterSkills\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterData\(uint32 character\_id, PlayerProfile\_Struct _pp, ExtendedProfile\_Struct_ m\_epp\);

      LoadCharacterCurrency\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterBindPoint\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterMaterialColor\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterBandolier\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterTribute\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterPotions\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      LoadCharacterLeadershipAA\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

  * Saves: Occur all over the code now instead of calling full saves

      SaveCharacterBindPoint\(uint32 character\_id, uint32 zone\_id, uint32 instance\_id, float x, float y, float z, float heading, uint8 is\_home\);

      SaveCharacterCurrency\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      SaveCharacterData\(uint32 character\_id, uint32 account\_id, PlayerProfile\_Struct _pp, ExtendedProfile\_Struct_ m\_epp\);

      SaveCharacterAA\(uint32 character\_id, uint32 aa\_id, uint32 current\_level\);

      SaveCharacterSpell\(uint32 character\_id, uint32 spell\_id, uint32 slot\_id\);

      SaveCharacterMemorizedSpell\(uint32 character\_id, uint32 spell\_id, uint32 slot\_id\);

      SaveCharacterMaterialColor\(uint32 character\_id, uint32 slot\_id, uint32 color\);

      SaveCharacterSkill\(uint32 character\_id, uint32 skill\_id, uint32 value\);

      SaveCharacterLanguage\(uint32 character\_id, uint32 lang\_id, uint32 value\);

      SaveCharacterDisc\(uint32 character\_id, uint32 slot\_id, uint32 disc\_id\);

      SaveCharacterTribute\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

      SaveCharacterBandolier\(uint32 character\_id, uint8 bandolier\_id, uint8 bandolier\_slot, uint32 item\_id, uint32 icon, const char\* bandolier\_name\);

      SaveCharacterPotionBelt\(uint32 character\_id, uint8 potion\_id, uint32 item\_id, uint32 icon\);

      SaveCharacterLeadershipAA\(uint32 character\_id, PlayerProfile\_Struct\* pp\);

  * Deletes:

      DeleteCharacterSpell\(uint32 character\_id, uint32 spell\_id, uint32 slot\_id\);

      DeleteCharacterMemorizedSpell\(uint32 character\_id, uint32 spell\_id, uint32 slot\_id\);

      DeleteCharacterDisc\(uint32 character\_id, uint32 slot\_id\);

      DeleteCharacterBandolier\(uint32 character\_id, uint32 band\_id\);

      DeleteCharacterLeadershipAAs\(uint32 character\_id\);

  * Now occur all over the code and only trigger when necessary
  * Two FULL saves when looting a corpse, this has been reduced to just currency saves on initial loot and trimmed to one save since AddToMoneyPP did it already
  * Every time a player moves coin with any situation \(Splits/Trades/Merchant/Skills/Bank Coin Exchange/Coin Moves\), a full save is made, this is now just a currency save
  * Every time a player skilled up at a skill vendor, a full blob save hit was made, this is not just a currency hit
  * Every time an AA was purchased, a full save was made
  * Every time a spell was scribed/swapped, disc was trained
  * When a client exists a zone, when a client enters a zone
  * NOTE: These amount of excessive saves have caused scalability issues that cause the `character_` table to hang which causes process hangs that affect the whole server

      because of the slowness of the `character_` table and the blob not allowing any indexing to occur

  * All functions that once depended on the `character_` table are now rewritten to appropriately read from the `character_data` table
  * Database query errors that occur during conversion or from and load/save/delete character functions are now leveraged via ThrowDBError and logs now go to

      Server\_Folder\_Root/eqemu\_query\_error\_log.txt \(You cannot log errors natively through MySQL\)

  * DBASYNC IS NOW COMPLETELY REMOVED \* This was mainly for Character data async loads/saves and merchantlist loads
  * Side implementations: Perl Exports:

    * quest::crosszonesetentityvariablebynpctypeid\(npctype\_id, id, m\_var\) \* Sets entity variables world wide with specified npctype\_id
    * quest::crosszonesignalnpcbynpctypeid\(npctype\_id, data\) \* Signals all NPC entities world wide with specified npctype\_id
    * $client-&gt;GetTaskActivityDoneCount\(TaskID, ActivityID\) \* Gets task activity done count by task id and activity id for client entity

    VIEW TABLE SIZE AFTER CONVERT:

    SELECT CONCAT\(table_schema, '.', table\_name\) as table\_name, CONCAT\(ROUND\(table\_rows / 1000000, 2\), 'M'\) rows, CONCAT\(ROUND\(data\_length / \( 1024  1024  1024 \), 2\), 'G'\) DATA, CONCAT\(ROUND\(index\_length / \( 1024  1024  1024 \), 2\), 'G'\) idx, CONCAT\(ROUND\(\( data\_length + index\_length \) / \( 1024  1024  1024 \), 2\), 'G'\) total\_size, ROUND\(index\_length / data\_length, 2\) idxfrac FROM information\_schema.TABLES WHERE `table_name` LIKE 'character_%' ORDER BY DATA DESC;

## 09/20/2014

* **mackal** Fix crash in SendEnterWorld on illegally long names
* **mackal** The client only lets you enter 15 characters for your name \(UF at least\)
* **mackal** Add rule Spells:SHDProcIDOffByOne for pre-UF spell file, set to true, UF+ set to false
* **KLS** \#suspend and \#ban now have required messages to record the reason for the ban/suspension.

## 09/19/2014

* **mackal** Added Client::Tell\_StringID \(used in tell queue messages\)
* **mackal** Tell queues \(and offline\) messages now show correctly
* **mackal** Fix starting with capital check

## 09/18/2014

* **mackal** Implement tell queues

    Currently set to a limit of 20 by default \(World:TellQueueSize\) I was unable to hit the limit on live though \(100+\)

    The required SQL nukes the old tell queue table, which may or may not be in your DB

    Optional SQL adds the rule to the DB to allow easy of change

    Note: this does not play well with multiple sessions with the same name on \(crash and relog and have multiple sessions\) but normal tells don't play well either

## 09/16/2014

* **mackal** Implement spell formula 137 \(BER AA Desperation\)

  Uleat \(NateDog\): Fix for LoadBuffs\(\) crash when a spell with a non-persistent Illusion effect was loaded.

* **mackal** Fix some effect calcs + implement more \(derived from the client\)

## 09/15/2014

* **Kayen** Nimbus effects will now be reapplied after zoning and will be removed when associated buff fades.

## 09/13/2014

* **mackal** Fix rogues not having Thieves' Cant

## 09/09/2014

* **mackal** Incrase Mob kick/bash timer by 3

    see: [http://www.eqemulator.org/forums/showthread.php?t=38734](http://www.eqemulator.org/forums/showthread.php?t=38734)

* **mackal** Fix slow effect on NPC special attack reuse timers

    see: [http://www.eqemulator.org/forums/showthread.php?t=38734](http://www.eqemulator.org/forums/showthread.php?t=38734)

* **mackal** Slow fixes to bots!
* **mackal** Revamped how NPC attack rate is set

    SQL: 2014\_09\_09\_attack\_delay.sql

* **mackal** Added attackdelay to \#npcedit

## 09/08/2014

* **mackal** Fix slow calc

    see: [http://www.eqemulator.org/forums/showthread.php?t=38734](http://www.eqemulator.org/forums/showthread.php?t=38734)

## 09/07/2014

* **Akkadius** Fixed ROF Augment item dupe with not checking for available slots properly and adding items to the virtual instance

## 09/06/2014

* **Uleat** Tweaked 'Smart' trading code to return main slots before sub slots in stackable and free space search processes. \(If enough people ask for it, I'll add an optional rule to allow 'bag packing' \* the original implementation behavior\)

## 09/05/2014

* **Uleat** Fix for cursor item loss when zoning. \(Thanks to the other devs who traced and fixed the 'macro' issue!\)
* **mackal** Fix size getting nuked with lua's SendIllusionPacket

## 09/03/2014

* **Secrets** Identified the routines needed to augment items in RoF. Currently, only Insert and Remove are supported. Swap and Destroy do not work due to missing functions related to the cursor.
* **mackal** Added work around command to show numhits on your buffs \(\#shownumhits\)
* **Uleat** Fix for timer issue introduced by Zone::ShutDown\(\) fix.

## 09/02/2014

* **Secrets** Identified OP\_GuildPromote for RoF clients.
* **Secrets** Fixed promotion, demotion, transferring a leader and displaying of client ranks in the Rain of Fear client. The rain of fear client, as such, will only have 3 ranks like the other clients, but supports a theoretical 8 ranks later.

  Secrets/ _\*Akkadius_ Fixed an issue involving character name lookup in the new DB code.

* **mackal** crash fix checking DivineAura in hate\_list.cpp
* **Secrets** Reverted some code that got in the main branch that shouldn't have gotten there.
* **Uleat** Changed \#loc to report the same precision as /loc for Cartesians

## 08/31/2014

* **KLS** Fixed a bug in fishing in S3D zones
* **KLS** Fixed a bug in turnins with new any abstraction
* **KLS** Fixed a few quest related inconsistencies.
* **KLS** Added Lua EntityList::ChannelMessage\(from, type, msg, language\)

## 08/30/2014

* **mackal** \(noudess\) Merchants should be more descriptive of why they don't sell to you

## 08/26/2014

* **Uleat** Implemented 'Smart' Player Trade transfers. Trades are processed by containers, stackables and then all remaining. QueryServ logs have been updated to match these transactions.

  Note: QueryServ logs previously listed 'Items' on the main entry table. This indicated the number of slots affected and not the actual number of items.

  This field now indicates the actual number of items transferred. For non-stackable, the value is '1' and stackable is the number of charges. A \_detail\_count

  property has been added to both 'Trade' and 'Handin' structs to indicate the number of details recorded..though, not tracked..it could be added.

## 08/24/2014

* **Uleat** Fix \(attempted\) for zone crashes related to zone shut-down. This change disables all Mob AI and disables/deletes all Mob timers once Zone::ShutDown\(\) is called. More areas will be addressed as reports come in.

  Note: Perl and Lua quests tested to work..please post any aberrant behavior. \(I finally set my spell-check to US English...\)

* **Akkadius** Character creation process crash fix and query cleanup
* **Akkadius** Created `character_lookup` table for applications that mirrors all `character_` table fields minus blob fields for application lookups
  * A 2.4GB character\_ table will take 7 seconds to query on a SSD versus .1s on the character\_lookup table
  * This also causes applications like Magelo to burst reads of the entire character table because of the blob fields that come with the reads, as much as 500-600MB/s even if a indexed id filter is provided
  * This field is synchronized on player save and has 0.001s DB hit
  * When we split out from the blob, ideally this table can be removed
  * Required SQL: utils\sql\git\required\2014\_08\_24\_character\_lookup.sql

## 08/23/2014

* **Akkadius** Changed zone process window title format, example: 'crushbone :: clients: 6 inst\_id: 1 inst\_ver: 0 :: port: 7015'
* **Akkadius** Most of the following changes are QueryServ related, fully implemented its original functionality to be able to offload

    intensive or metric based logging to a remote server process that could exist on another server entirely

* **Akkadius** Implemented Player Event Logging Types \(Go to table `qs_player_events`\)

```text
      1 = Player_Log_Quest,
      2 = Player_Log_Zoning,
      3 = Player_Log_Deaths,
      4 = Player_Log_Connect_State,
      5 = Player_Log_Levels,
      6 = Player_Log_Keyring_Addition,
      7 = Player_Log_QGlobal_Update,
      8 = Player_Log_Task_Updates,
      9 = Player_Log_AA_Purchases,
      10 = Player_Log_Trade_Skill_Events,
      11 = Player_Log_Issued_Commands,
      12 = Player_Log_Money_Transactions,
      13 = Player_Log_Alternate_Currency_Transactions,
  * All QueryServ logging will be implemented with a front end in EoC 2.0 very soon
  * Architecture page: http://wiki.eqemulator.org/p?QueryServ_Architecture
```

* **Akkadius** Changed all QS Error related logging to 'QUERYSERV\_\_ERROR'
* **Akkadius** \(Natedog\) \(Crash Fix\) Legacy MySQL bug revert for loading AA's
* **Akkadius** Implemented Perl Quest objects \(LUA still needed to be exported\):
  * quest::qs\_send\_query\("MySQL query"\) \* Will send a raw query to the QueryServ process, useful for custom logging
  * quest::qs\_player\_event\(char\_id, event\_desc\); \* Will process a quest type event to table `qs_player_events`
* **Akkadius** Added MySQL Tables
  * `qs_player_aa_rate_hourly`
  * `qs_player_events`
  * Source table structures from:
    * utils\sql\git\queryserv\required\08\_23\_2014\_player\_events\_and\_player\_aa\_rate\_hourly

      To get the complete QueryServ schema, source from here:

    * utils\sql\git\queryserv\required\Complete\_QueryServ\_Table\_Structures.sql
* **Akkadius** Added rules for each logging type, source rules here with them enabled by default:
  * utils\sql\git\queryserv\required\Complete\_QueryServ\_Rules\_Enabled.sql
* **Akkadius** Spawn related logging cleanup
* **Akkadius** General code cleanup
* **Akkadius** More to come for QueryServ

## 08/22/2014

* **Uleat** Rework of Trade::FinishedTrade\(\) and Trade::ResetTrade\(\) to parse items a little more intelligently.

Trade window items are now sent to client inventory in this order:

* Bags
* Partial stack movements
* All remaining items

If any of these procedures cause any problems, please post them immediately.

## 08/20/2014

* **Uleat** Rework of Trade::AddEntity\(\) \* function used to move items into the trade window. Now accepts argument for 'stack\_size' and updates client properly.

  Note: I tested trade with Titanium:{SoF,SoD,UF,RoF} in both directions and no client generated an OP\_MoveItem event for attempting to place a stackable

  onto a partial stack already in the trade window. The only way to achieve stacking is to click on the receiving client. If there is a partial stack remaining

  on the cursor after the OP\_MoveItem event, and there is room available, the client will generate subsequent events to move the remaining count.

## 08/19/2014

* **Akkadius** Implemented a Stop\_Return feature \(Accidental item handin prevention\) that will be symmetrically used with plugin::return\_items that I am currently running live testing on EZ before releasing to EQEmu. This does not hurt to have this in the source.
* **Akkadius** Fixed crash where 'attacker' validation is not being checked
* **Akkadius** Removed petition console spam that does not follow traditional logging and is useless
* **Akkadius** Made fix with SympatheticProcChances where it was checking for TempItem-&gt;Focus.Effect instead of TempItemAug-&gt;Focus.Effect

## 08/18/2014

* **Uleat** Fix for [https://github.com/EQEmu/Server/issues/127](https://github.com/EQEmu/Server/issues/127) -\* also activated a remarked action in doors.cpp to eliminate a memory leak.

## 08/16/2014

* **KLS** \(addmoreice\) Trying out some unstable DB changes.  Do backup your database before trying them as master will be considered unstable for a few days at least.

  Uleat \(Noudness\): Fixed a floating-point comparison error that led to the notorious 'client bounce' \(this is not related to the

  'mob falling' due to not having maps installed.\) This fix also eliminates a sizeable amount of unnecessary out-going packets due

  to invalid orientation corrections.

  Note: This patch is probably of significant enough importance that admins may wish to manually apply this to older server builds.

  The number of packets reduced per second should be approximately \(num\_stationary\_close\_clients  _\(num\_close\_clients_  1\)\). This will

  likely have the most effect in zones like: Nexus, Bazaar, Guilds \(Halls\) and RAID INSTANCES \* where players don't move around a lot.

## 08/15/2014

* **Uleat** Reactivated the Bot::Spawn\(\) code for sending post-spawn wear change updates..temporary until I can sort out the proper usage.

## 08/13/2014

Uleat \(Kingly\_Krab\): Fix for bot chest armor graphic glitch. \(fix also caused RoF \#wc to work properly\)

## 08/02/2014

* **Kayen** Implemented spell\_news fields
* npc\_no\_los \(check if LOS is required for spells\)
* InCombat, OutofCombat \* Used together to restrict spells to only be cast while

  in/out of combat \(beneficial\) or if target is in/out of combat \(detrimental\).

  -min\_dist, min\_dist\_mod, max\_dist, max\_dist\_mod \* Scales spell power based on targets distance from caster.

  \*This will require further work to fully implement but will work with 90% of live spells as is.

  \*If making custom spells do not include effects that can't be scaled \(like a spell trigger\)

* min\_rage sets minimum distance range that must be away from target.

{% hint style="info" %}
**Required SQL** utils/sql/git/required/2014\_08\_02\_spells\_new.sql
{% endhint %}

## 07/31/2014

* **Uleat** More inventory slot constant conversions. This should be the bulk of everything..but, due to the size of the server code, there

  may be some hidden ones. \(client\_packet.cpp and the client translators still need a thorough review.\)

  Note: Please report any abnormal behaviour with inventory-related content..each diff file was reviewed 3 times..but, things CAN be missed.

* **Uleat** Test fix for client crashes in Bazaar, while actively selling, with a charm in the Trader's Satchel.

## 07/27/2014

* **Uleat** More updates to the dictionary. Added a 'constants' file for each client translator..these will tie-in to the dictionary. Started

  replacement of hard-coded numeric values with a pre-defined constant. This will help in the transition.

## 07/16/2014

* **Uleat** Initial commit of new client/server 'dictionaries' \* work in-progress... Changed equipment slot references to reflect new naming

  conventions. Lua enumerations maintain both the old and new names as to not break existing scripts..but, the old names are deprecated.

## 07/14/2014

* **KLS** Changes to CMake build
  * Lua builds by default now
  * Common has been renamed common
  * Binary files will now be put into ${CMAKE\_BINARY\_DIR}/bin instead of ${CMAKE\_BINARY\_DIR}/Bin
  * The last two are of note to people on non-windows systems as case sensitivity is important.  Edit your scripts accordingly, thank you.

## 07/10/2014

* **Kayen** Updated table npc\_spells to now support defensive and ranged procs.

  Note: Proc rate modifier work as it does for spell effects \(ie 200 = 200% baseline chance modifier\)

  Table is also now contains 12 AI spell casting variables that can be set to fine tune casting behaviors per spell set.

  Global default rules have also been added that can further fine tune all content if no specific variables are set.

Descriptions of new AI casting fields in npc\_spells 'fail\_recast' AI spell recast time\(MS\) when an spell is cast but fails \(ie stunned\) 'engaged\_no\_sp\_recast\_min' AI spell recast time\(MS\) checked when no spell is cast while engaged in combat. \(min time in random\) 'engaged\_no\_sp\_recast\_max' AI spell recast time\(MS\) checked when no spell is cast while engaged in combat. \(max time in random\) 'engaged\_b\_self\_chance' Chance during first AI Cast check to do a beneficial spell on self \(ie check to heal self\) 'engaged\_b\_other\_chance' Chance during second AI Cast check to do a beneficial spell on others.\(ie check to heal others\) 'engaged\_d\_chance' 'Chance during third AI Cast check to do a determental spell on others \(ie check to nuke others\) 'pursue\_no\_sp\_recast\_min' AI spell recast time\(MS\) checked when no spell is cast while chasing target. \(min time in random\) 'pursue\_no\_sp\_recast\_max' AI spell recast time\(MS\) checked when no spell is cast while chasing target. \(max time in random\) 'pursue\_d\_chance' Chance while chasing target to cast a detrimental spell. 'idle\_no\_sp\_recast\_min' AI spell recast time\(MS\) checked when no spell is cast while idle. \(min time in random\) 'idle\_no\_sp\_recast\_max' AI spell recast time\(MS\) checked when no spell is cast while idle. \(max time in random\) 'idle\_b\_chance' Chance to cast a beneficial spell while idle \(ie cast heal on self while out of combat\).

* **Kayen** Updated table npc\_types, adding field 'ranged\_type' and 'ammo\_idfile' 'ranged\_type' Will set what skill / animation is used when NPC uses a ranged attacked \(special ability 11\) 'ammo\_idfile' Will set what projectile graphic an NPC uses in a ranged attacked \(special ability 11\) Format IT\#\#\#\# \(same as item 'idfile'\) \(_Set to IT11118 for some fun_\) Added parameters: SPECATK\_RANGED\_ATK = 11 Param0: Min Ranged distance \(default: 25\) Param1: Max Ranged distance \(default: 250\) Param2: Percent Chance to Hit modifier Param3: Percent Total Damage modifier
* **Kayen** Updated to Chance to Hit code with how bonuses are applied to be consistent for all effects. Added field to npc\_types 'Avoidance' which will modify chance to avoid melee Added rules to set max and min chance to hit from melee/ranged \(Default 95% / 5%\)

Required SQL: utils/sql/git/required/2014\_07\_10\_npc\_spells.sql Optional SQL: utils/sql/git/optional/2014\_07\_10\_AICastingRules.sql

## 07/5/2014

* **Kayen** Updated SE\_Sanctuary \* Adjust way hate lowering effect worked to be more accurate
* **Kayen** Updated SE\_SympatheticProc \* Revised proc rate formula to be accurate to live.

  Sympathetic foci on items with proc rate mod will now benefit from that modifier.

  Sympathetic foci can now be placed on AA's \(This should always be slot1 in the AA\)

* **Kayen** Implemented SE\_IllusionPersistence\* Allows illusions to last until you die or the illusion is forcibly removed.
* **Kayen** Added rule 'PreNerftBardAEDot' for SE\_BardAEDot to allow it to once again do damage to moving targets. \(Set to true\)
* **Kayen** Completely revised SE\_SkillProc, SE\_LimitToSkill, SE\_SkillProcSuccess to overall just work better and more accurately, AA support.

Required SQL: utils/sql/git/required/2014\_07\_04\_AA\_Update.sql

## 07/2/2014

* **Kayen** Implemented SE\_Sanctuary \* Places caster at bottom hate list, effect fades if caster cast spell on targets other than self.
* **Kayen** Implemented SE\_ResourceTap \* Coverts a percent of dmg from dmg spells\(DD/DoT\) to hp/mana/end.
* **Kayen** Implemented SE\_FactionModPct \* Modifies faction gains and losses by percent.
* **Kayen** Re-Implemented SE\_TriggerMeleeThreshold and SE\_TriggerSpellThreshold correctly \* Trigger spell if owner of buff

  takes more than the specified damage amount in a SINGLE hit, then fade the buff.

* **Kayen** Implemented SE\_LimitSpellClass \* Focus Limits spell to pre defined categories. \(3=Cures,3=Offensive, 6=Lifetap\)
* **Kayen** Changed SE\_LimitMaxMana to SE\_MeleeVulnerability \* Weakness/Mitigation verse melee damage

  \(Despite lives SPA lable as the former it clearly is not what the effect does from all spell examples\)

* **Kayen** Updated SE\_BardAEDot to no longer damage target while target is moving \(consistent with live\)
* **Kayen** Update SE\_InterruptCasting: Will now work for instant spells \(as well as over time\).

## 06/25/2014

* **Kayen** Updated SE\_Hate \(Renamed from SE\_Hate2\) to now properly work for instant +/\* hate spells.
* **Kayen** Updated SE\_FadingMemories \* Base value will be properly utilized to set % chance for fade effect to work.
* **Kayen** Implemented SE\_StrikeThough \(Was incorrectly defined as implemented previously\) \* Works same as item bonus.
* **Kayen** Update SE\_Taunt \* Limit value if present will now add instant hate.
* **Kayen** Implemented SE\_MassGroupBuff \* Allows next group buff cast to be a MGB \(AA now uses this\)
* **Kayen** Implemented SE\_IllusionOther \* Allows next Illusion buff \(self only\) cast to be cast on target. \(AA now uses this\)
* **Kayen** Update SE\_AETaunt \* Base value will now determine AE taunt range \(This will not result in any change to currently used spells\).
* **Kayen** Updated SE\_ReclaimPet \* Correct forumla for mana returned to properly return 75% of actual pet spell mana cost.
* **Kayen** Implemented SE\_ImprovedReclaimEnergy \* Modifies % mana returned from SE\_ReclaimPet.
* **Kayen** Implemented SE\_HeadShot, SE\_HeadShotLevel \* Defines headshot damage and level requirements.

  Revised HeadShot mechanic so damage now receives all archery bonuses, proc chance can be set to either \(lives new Proc Per minute

  system, or flat chance based on dex \(formula updated\).

* **Kayen** Implemented SE\_Assassinate, SE\_AssassinateLevel \* Defines assassinate damage and level requirements.

  Revised Assassinate mechanic so damage now receives all backstab bonuses, proc chance can be set to either \(lives new Proc Per minute

  system, or flat chance based on dex \(formula updated\). Assassinate can now proc from THROW if behind target, various other adjustments.

* **Kayen** Fix to AA Finishing Blow missing aa\_effects data, update required SQL.

  Revised Finishing blow so that damage now receives all melee bonus. Support also for this effect if placed on items or spells.

* **Kayen** Implemented SE\_PetMeleeMitigation \* Bonus applied to pet owner. Gives AC to owner's pet.

{% hint style="info" %}
**Required SQL** utils/sql/git/required/2014\_06\_25\_AA\_Update.sql 

**Optional SQL** utils/sql/git/optiional/2014\_06\_29\_HeadShotRules.sql
{% endhint %}

## 06/17/2014

* **Kayen** Implemented SE\_AStacker, SE\_BStacker, SE\_CStacker, SE\_DStacker.

  These effects when present in buffs prevent each other from stacking,

  Any effect with B prevents A, C prevents B, D prevents C.

* **Kayen** Implemented SE\_DamageModifier2 \(Stacks with SE\_DamageModifier, mods damage by skill type\)
* **Kayen** Implemented SE\_AddHatePct \(Modifies +/\* your total hate on NPC by percent\)
* **Kayen** Implemented SE\_AddHateOverTimePct \(Modifies +/\* your total hate on NPC by percent over time\)
* **Kayen** Implemented SE\_DoubleRiposte \(Modifies +/ _your double riposte chance\)_ Not used in any live effects
* **Kayen** Implemented SE\_Berserk \(Sets client as 'Berserk' giving chance to crippling blow\) \*Not used in any live effects
* **Kayen** Implemented SE\_Vampirsm \(Stackable lifetap from melee effect\) \*Not used in any live effects
* **Kayen** Minor fixes to how lifetap from melee effects are calced. Removed arbitrary hard cap of 100%, Negative value will now dmg client.
* **Kayen** Fix to issue that prevented NPC's from receiving HP Regeneration derived from spell buffs.
* **Kayen** Fixes and Updates for melee and spell mitigation runes.
* **Kayen** Update to SE\_NegateAttack, 'max' value can now set upper limit of damage absorbed. DOT ticks will no longer be absorbed.
* **Kayen** Implemented SE\_Metabolism \* Modifies food/drink consumption rates. \[Data for AA is already in database\]
* **Kayen** Update to SE\_BalanaceMana, SE\_BalanceHP to support limit value which caps max mana/hp that can be taken per player.

## 06/13/2014

* **Kayen** For table 'npc\_spell\_effects\_entries' setting se\_max for damage shield effects \(59\) will now determine the DS Type \(ie burning\)

  Setting se\_max to 1 for SkillDamageTaken effects \(127\) will allow for stackable mitigation/weakness same as quest function ModSkillDmgTaken.

* **Kayen** Implemented SE\_AlterNPCLevel \(not currently used on live\). Will +/\* to NPC level. When fade will revert back to original level.
* **Kayen** Implemented 'special\_abilities' 38 ALLOW\_BENEFICIAL \(Allows an NPC to recieve player buffs/heals\)
* **Kayen** Implemented 'special\_abilities' 39 DISABLE\_MELEE \(Prevents NPC from auto attacking, will still aggro\)

  Note: These two special abilities were previously implemented and still remain as quest functions. \(SetDisableMelee\(\) and SetAllowBeneficial\(\)\)

## 06/8/2014

* **KLS** Changed lua API: eq.get\_globals\(client, npc\) has been removed.  Use eq.get\_globals\(npc, client\) instead.

  There's a bug with something in gcc 4.6.3 \(maybe other versions\) on x86 that this is attempting to combat.

## 05/17/2014

* **Secrets** Identified the opcode/struct for guild ranks in Rain of Fear+ clients.
* **Secrets** Implemented a work-around for Rain of Fear clients to have all guild permissions until proper database support is added for newer ranks.

## 05/14/2014

* **Kayen** Rooted NPC's will no longer target players with Divine Aura effect if they are the closest target and other targets exist on the hate list.

## 05/12/2014

* **Uleat** Re-arranged functions in Item.cpp to somewhat match the order they are declared in Item.h. Should make finding their location a little easier when using declarations as a guide. \(This will facilitate readability of an upcoming change...\)

## 05/07/2014

* **Kayen** AA/Item/Spells that allow pets to critical and flurry will now work on the owners swarm pets consistent with live.

## 05/05/2014

* **Uleat** Oops! Wrong state check \(conn\_state != client\_state\)
* **Uleat** Test fix to eliminate seemingly random crashes when an AE spell is being used. \(Possible access to uninstantiated pointers during client connection process when someone casts a beneficial AE spell within range of a connecting client.\)

## 04/29/2014

* **KLS** Implemented new map code based on some of Derision's earlier work.  Old maps still work with this system and don't need to be regenerated. We're still working on a new azone solution for better/more efficient maps.

## 04/27/2014

* **Kayen** Implemented new table 'npc\_spells\_effects' and 'npc\_spells\_effects\_entires'
* Implemented new field in 'npc\_spell\_effects\_id' in npc\_types.
  * These are used to directly apply spell effect bonuses to NPC's without requirings spells/buffs. Example: Allow an npc to spawn with an innate 50 pt damage shield and a 5% chance to critical hit. Please see the wiki page: [http://wiki.eqemulator.org/p?npc\_spell\_effects\_entries](http://wiki.eqemulator.org/p?npc_spell_effects_entries) for details. \*NPC's can now do critical heals / damage spells if bonus is applied from table.

## 04/25/2014

* **cavedude** Corrected a crash in spawn\_conditions caused by NPCs on a one way path.
* **cavedude** Added strict column to spawn\_events which will prevent an event from enabling if it's mid-cycle.
* **cavedude** Prevented disabled or strict spawn\_events from enabling when the zone first boots.
* **cavedude** Fixed the quest function toggle\_spawn\_event under Perl.

If you're using the quest function toggle\_spawn\_event \(worked on Lua only\) it has changed syntax to: toggle\_spawn\_event\(int event\_id, bool enable, bool strict, bool reset\_base\)

{% hint style="info" %}
**Required SQL** utils/sql/git/required/2014\_04\_25\_spawn\_events.sql
{% endhint %}

## 04/23/2014

* **Kayen** Improved SE\_LimitCombatSkills will now more accurately determine if a spell is a combat proc.
* **Kayen** SE\_LimitInstant will now also work when set to include instant spells

{% hint style="info" %}
**Optional SQL** utils/sql/git/optional/2014\_04\_23\_FocusComabtProcs.sql Note: Set to false, if enabled will allow all combat procs to receive spell focuses.
{% endhint %}

## 04/21/2014

* **Secrets** Crash fix for more hatelist crashes.
* **Secrets** Hate list fixes, again.
* **Secrets** Revert of hatelist changes.

## 04/20/2014

* **Secrets** Changed the functionality of EQDEBUG cmake flag. It now suppresses logs, but shows crashes in any scenario when set to 1. It will also now show crashes even if the log system is disabled.
* **KLS** Change to how quest signals work, signals with no delay will now be added to the signal queue.  This addresses an odd timing issue where NPCs are in a state of life/death flux when a signal from event\_death goes off.
* **KLS** Added cmake flags to define how logging behavior works for each different log type.
* **Secrets** Crash fix for Hatelist crash observed

## 04/18/2014

* **Akkadius** Added \#command error message suppression for those who don't want to see 'Command is not recognized' constantly
  * You need to have rule 'Chat:SuppressCommandErrors' set to true, this is set to false by default

{% hint style="info" %}
**Required SQL** 2014\_04\_18\_Suppress\_Command\_Error.sql
{% endhint %}

## 04/15/2014

* **Akkadius** Exported $client-&gt;SendMarqueeMessage\(type, priority, fade\_in, fade\_out, duration, msg\) \* Will be available for simple plugin use
* **Akkadius** Exported $client-&gt;ExpeditionMessage\(THIS, ExpdID, Message\) 
* In use with custom expedition mod that will be released soon

## 04/12/2014

* **Kayen** Fixed an with the slow mitigation code that would cause it to spam the message. Optimized the way the variable is handled for slow mitigation.

{% hint style="info" %}
**Required SQL** utils/sql/git/required/2014\_04\_12\_SlowMitigation.sql 

This changes the variable type in the sql table from FLOAT to INT and updates your database

 \(When setting slow mitigation 50 = 50%, 100 = 100% ect. You can also set &gt; 100 which will cause slow to become haste now with appropriate in game msg given\)
{% endhint %}

## 04/10/2014

* **Kayen** Added 'no\_target\_hotkey' field to npc\_types table. This will prevent the NPC from being targeted with F8 \( _\*Warning_ Will also turn it's name YELLOW\)
* **Kayen** Added a rule to make all \(Player cast\) Swarm Pets not targetable with F8 \(nearest NPC\) by default \( _\*Warning_ Will also turn pets names YELLOW\). This is semi-hack but it works.
* **Kayen** Player cast swarm pets can now be healed and buffed consistent with live.

{% hint style="info" %}
**Optional SQL** utils/sql/git/optional/2014\_04\_10\_SwarmPetNotTargetableWithHotKey.sql

**Required SQL** utils/sql/git/required/2014\_04\_10\_No\_Target\_With\_Hotkey.sql 

Note: For the required new npc\_types field you DO NOT need to set values for swarm pets if you enable the above rule.
{% endhint %}

## 04/09/2014

* **Kayen** Implemented ability to use the actual live spell projectile graphics that are defined in the modern spell file.

   \*This is disabled by default. Recommend enabling if your server uses an UF+ spell file AND most of your players use UF+ clients.

* **Kayen** Expanded the PERL ProjectileAnim\(mob, item\_id, \[IsArrow?, speed, angle, tilt, arc, IDFile\]\) so you can now just set the weapon model graphic IT\#\#\#\#

  Example: ProjectileAnim\($npc, 0, 0, 1, 0, 0, 0, "IT10747"\)  This will shoot an SK 2.0 sword.

* **Kayen** Updated wizard innate critical damage modifier to be from 20-70% of base damage \(based on live parses\)

{% hint style="info" %}
**Optional SQL** utils/sql/git/optional/2014\_04\_09\_SpellProjectileRule.sql Note: This sql also contains a query to check if your spell file is compatible.
{% endhint %}

## 04/06/2014

* **Uleat** Changed Mob::CanThisClassDualWield\(\) behavior. This should let non-monk/beastlord dual-wielding classes attack with either fist as long as the other hand is occupied.

  Notes: See this thread for more information and to provide feedback: [http://www.eqemulator.org/forums/showthread.php?p=229328\#post229328](http://www.eqemulator.org/forums/showthread.php?p=229328#post229328)

## 04/05/2014

* **Akkadius** Fix for the Fix for the Fix: Rule Combat:OneProcPerWeapon was created so that you can revert to the original proc functionality for custom servers that have balanced their content around having more than 1 aug proc on weapons. By having this rule set to 'false' you revert this functionality. This rule is set to 'true' by default as the original functionality from Live was intended to be
* **Akkadius** \(Performance Adjustment\) Removed AsyncLoadVariables from InterserverTimer.Check\(\) in both zone and world. By watching the MySQL general.log file on mass zone idle activity, you can see that the query 'SELECT varname, value, unix\_timestamp\(\) FROM variables where unix\_timestamp\(ts\) &gt;= timestamp' is called every 10 seconds. This function is loading variables that are initially loaded on World and Zone bootup. When running a large amount of zone servers, the amount of MySQL chatter that is produced is enormous and unnecessary. For example, if I ran 400 zone servers, I would see 3,456,000 unnecessary queries from all idle or active zone processes in a 24 hour interval.
* **Secrets** Added a rule to enable multiple procs from the same weapon's other slots if a proc is deemed to trigger, Defaults to true.If Combat:OneProcPerWeapon is not enabled, we reset the try for that weapon regardless of if we procced or not. This is for some servers that may want to have as many procs triggering from weapons as possible in a single round.

{% hint style="info" %}
**Optional SQL** utils/sql/git/optional/2014\_04\_05\_ProcRules.sql
{% endhint %}

## 04/04/2014

* **Kayen** Implemented 'Physical Resists' \(Resist Type 9\) to be consistent with live based on extensive parsing. SQL will add new field to npc\_types 'PhR' and fill in database with values consistent with observations

{% hint style="info" %}
**Required SQL** utils/sql/git/optional/2014\_04\_04\_PhysicalResists.sql
{% endhint %}

## 04/03/2014

* **Kayen** Implemented live like spell projectiles \(ie. Mage Bolts\).

{% hint style="info" %}
**Optional SQL** utils/sql/git/optional/2014\_04\_03\_SpellProjectileRules.sql 

Note: The rules in this SQL are for setting the item id for the graphic used by the projectile on different clients.
{% endhint %}

## 04/01/2014

* **mackal** Implemented ability for a merchant to open and close shop. Lua quest functions: e.self:MerchantOpenShop\(\) and e.self:MerchantCloseShop\(\). GM Commands: \#merchant\_open\_shop \(short: \#open\_shop\) and \#merchant\_close\_shop \(short: \#close\_shop\) default to status 100, just in case you need to force the merchants status
* **Trevius** Fixed potential endless quest loop with EVENT\_COMBAT and WipeHateList\(\).

## 03/31/2014

* **Uleat** Fix for unconscious skillups.
* **Uleat** Fix for crash issue with nullptr reference in recent Client::SummonItem\(\) work.
* **Uleat** Added rule for GM Status check code in Client::SummonItem\(\).

  Note: Rule default is set to 250..but, implementation is on hold until load item code handles the database 'minstatus' field.

* **Uleat** Added RuleB\(Bots, BotLevelsWithOwner\). Bots will auto-update as their owner levels/de-levels. Appearance packets are sent to show the 'leveling effect' as well as updating client entities.
* **Trevius** Prevented an endless loop crash related to EVENT\_TASK\_STAGE\_COMPLETE.

Optional Bot SQL: utils/sql/git/bot/optional/2014\_03\_31\_BotLevelsWithOwnerRule.sql Note: This sql is required to activate the optional behavior.

## 03/27/2014

* **Kayen** SE\_Gate will now use have a fail chance as defined by its base value in the spell data.
* **Kayen** SE\_Succor will now have a baseline fail chance of \(2%\). Rule added to adjust this as needed.
* **Kayen** SE\_FeignDeath will now have a fail chance as defined by its base value in the spell data.

Optional SQL: utils/sql/git/optional/2014\_03\_27\_SuccorFailRule.sql

## 03/22/2014

* **Uleat** Moved the existing 'load\_bots' and 'drop\_bots' sqls into the emu git repository for the time being. Look to the

    /utils/sql/git/bots/ folder to find them. The 'load\_bots' sql has been updated to include the below fix, as well as

    collecting the multiple files into one. This should allow HeidiSQL to now run  it properly. \(You will still need to

    search for the optional scripts for the time being.\)

* **Uleat** Fixed bot guild script failure. For existing bot databases only, use this sql file to update the affected table and view.

Required Bot SQL: 2014\_03\_22\_BotGuildMember\_ScriptFailureFix.sql

## 03/19/2014

* **Kayen** Further refinements to root, charm, mez and fear behaviors \* See commit message for full details

New rule for 'Fear' break chance, and updates to default settings of various rules. Optional SQL: utils/sql/git/optional/2014\_03\_19\_RulesUpdates.sql

## 03/18/2014

* **Uleat** Fixed the name/account discrepancy in the Client::SummonItem\(\) code as well as the origin of the mistake \(thanks K\_K!\)
* **Uleat** Condensed and rearranged certain snippets of code in SummonItem\(\). Added a 'augslotvisible' check to validation check.

  Note: If you are experiencing issues with SummonItem, please enable 'INVENTORY\_ERROR' logging if it not active on your server.

## 03/17/2014

* **Uleat** Updated Client::SummonItem\(\) to check for valid item combinations when augmentations are passed.
* **Uleat** Changed the return type of Client::SummonItem\(\) from void to bool. Calling methods and APIs have not been update as yet.
* **Uleat** Fixed the RoF Item structure to properly pass the 'augrestrict' variable. RoF clients now show restrictions in the Item Information window.

Optional SQL: 2014/03/17\_EnforceAugmentRules.sql Note: This adds the rules Inventory:EnforceAugmentRestriction, Inventory:EnforceAugmentUsability and Inventory:EnforceAugmentWear. If you run into script/recipe issues, running this sql file will set the default enforcement rules to false. If you still run into issues, you may want to check that your scripts are not trying to augment non-common items. Please post any failures as bugs and be sure to include the base item ID, as well as any augment IDs that you are using.

## 03/12/2014

* **Kayen** Melee/Magic runes are now calculated as bonuses. Resolved issues with runes not working and not fading properly.

## 03/08/2014

* **Kayen** Revision to lull/harmony/pacification code to be consistent with live based on extensive personal parsing.

  \*Lulls on initial cast do not check regular resists \(MR ect\) but only apply a flat ~7.5 % resist chance + level modifier

  \*If Lull is resisted, a second resistance check is made this time using regular resists and a charisma modifier \(same as charm\)

  which if 'resisted' will cause the caster to gain aggro.

## 03/05/2014

* **mackal** Corrected rogue's evade to be single target
* **sorvani** fixed crash issue 119

## 03/04/2014

* **Sorvani** Created RemoveFromInstance and RemoveAllFromInstance to remove a single player or all players in an instance.
* **Sorvani** Exported to Lua as eq.remove\_from\_instance\(instance\_id\) and eq.remove\_all\_from\_instance\(instance\_id\).
* **Kayen** Revision to root code to be consistent with live based on extensive personal parsing.

  \*ROOT has a 40% chance to do a resist check to break each buff tick.

  \*If multiple roots on target. Root in first slot will always and only be check to break from nukes.

  \*If multiple roots on target and broken by spell. Roots are removed ONE at a time in order of buff slot.

  \*Roots on beneficial spells can not be broken by spell damage.

Optional SQL: utils/sql/git/optional/2014\_03\_04\_RootRule.sql

## 03/03/2014

* **mackal** Implemented deadly strikes and gave rogues higher innate throwing crit chance

New rules: Combat:RogueCritThrowingChance, Combat:RogueDeadlyStrikeChance, Combat:RogueDeadlyStrikeMod Defaults should give fairly close to live results

## 03/02/2014

* **Kayen** Revision to charm code to be consistent with live based on extensive personal parsing.

  \*Charisma ONLY effects the initial resist check when charm is cast with 10 CHA = -1 Resist mod up to 200 CHA

  \*Charisma DOES NOT extend charm durations.

Optional SQL: utils/sql/git/optional/2014\_03\_02\_CharmRules.sql

* **mackal** Melee Crits, HoTs, DoTs messages should now be filtered correctly on all clients.

    Clients that also support seeing others DoTs will now see them if they don't filter them

    note: some newer clients have a 'mine only' option for HoTs but it functions the same as show

## 02/27/2014

* **cavedude** Exported TrainDisc to Lua.

## 02/26/2014

* **Kayen** Implemented SE\_FrenziedDevestation \* increase critical spell chacnce and 2x mana cost for DD spells
* **Kayen** Fixed SE\_SpellProcChance \* Now works on spell dervived procs
* **cavedude** Added two new NPC special\_abilities. ALWAYS\_FLEE, which forces the NPC to always flee ignoring FleeIfNotAlone and FLEE\_PERCENT which allows you to change the HP an individual NPC will flee at. If no value is set, the rule is used as normal.
* **cavedude** Fixed an issue where rectangular roamboxes could cause an NPC to get stuck on a single coord.
* **cavedude** Added a new roambox column, mindelay allowing you to have more control over the roambox delay.
* **Uleat** Fix for 'sqrt' failure on vs2010 clients
* **image** Added idle zone timer to save CPU cycles.

Required SQL: utils/sql/git/required/2014\_02\_26\_roambox\_update.sql

## 02/24/2014

* **cavedude** Better flee runspeed calculation. Added rule Combat:FleeMultiplier to alter this behavior.
* **Sorvani** Updated GetUnusedInstanceID to not recycle instance ID's unless it has reached max \(65535\)

## 02/23/2014

* **Secrets** Exported the client object SendTargetCommand to Perl.
* **cavedude** Merchants will now keep better track of charges.

## 02/20/2014

* **Kayen** Implemented SE\_MitigateDotDamage    \* dot spell mitigation rune with max value
* **Kayen** Implemented SE\_DistanceRemoval \* removed from target when target moves X amount of distance away from where initially hit.

Required SQL: utils/sql/git/2014\_02\_20\_buff\_updates.sql

## 02/18/2014

* **Kayen** Implemented SE\_TriggerOnReqCaster \* triggers a spell which a certain criteria are met \(below X amount of hp,mana,end, number of pets on hatelist\)
* **Kayen** Implemented SE\_ImprovedTaunt    \* Locks Aggro On Caster and Decrease other Players Aggro by X% on NPC targets below level Y
* **Kayen** Fixed an error where SE\_ChangeAggro was adding its bonus x 2 for spell generated aggro. \(this applies also to spell casting subtlety AA reduction\)

## 02/14/2014

* **Kayen** Fixes for buffs not fading under certain conditions in revised numhits system, and other fixes.
* **Kayen** Implemented support for spell\_new field CastRestrictions \(limits what type of targets spells can effect\).

  _A detailed list describing what the values used in this field do can be found in Mob::PassCastRestriction_

* **Kayen** Implemented support for spell\_new field not\_reflectable, no\_partial\_resists.

Required SQL: utils/sql/git/2014\_02\_13\_spells\_new\_updates.sql Names many unknown fields in the table.

## 02/13/2014

* **Sorvani** Renamed the instance\_lockout and instance\_lockout\_player tables to instance\_list and instance\_list\_player. Cleaned up the Database::GetUnusedInstanceID logic.

Required SQL: utils/sql/git/2014\_02\_13\_Rename\_instance\_lockout\_tables.sql

## 02/10/2014

mackal \(Secrets\): Re-wrote the entity list to be a std::map. This should be used for direct entityID lookups and is noticably faster performance-wise. Also should result in less nil pointers potentially.

* **Secrets** Fixed a crash issue that could occur on \#repop related to quest timers.
* **Kayen** Divine Arbiration and other similar spell effects will now utilize a spell range check.
* **Kayen** Revised how heal amount is calculated to properly incorporate all current focus effects/bonuses.
* **Kayen** Various updates/fixes/clean-ups to focus effect related code. Focus effect limits should now all work properly.

## 02/09/2014

* **Sorvani** Added new spawn condition onchange action: DoRepopIfReady. Choosing this will not repop mobs when the spawn condition is enabled if they have an existing respawn timer. Additionally, this condition will not even attempt repop when the condition is is changed to disabled. Will be in use on PEQ for: Cragbeast Queen in Natimbi.
* **Secrets** Fixed a weird crash issue with deletion of pointers if task loading fails.

## 02/2/2014

* **Kayen** Revised how spell/dot damage is calculated to properly incorporate all current focus effects/bonuses.

Required SQL: utils/sql/git/2014\_02\_02\_SpellCriticalsAA.sql

## 01/27/2014

* **Kayen** Implemented SE\_CriticalMend  \(chance to critical monk mend\)
* **Kayen** Implemented SE\_IncreaseChanceMemwipe \(increases the chance to wipe hate with memory blurr\)
* **Kayen** Implemented SE\_FcStunTimeMod \(modify stun duration from casted spells\)
* **Kayen** Implemented SE\_StunBashChance \(increase chance to stun from bash\)

Required SQL: utils/sql/git/2014\_01\_27\_CritcalMendAA.sql

## 01/26/2014

* **Kayen** Revised 'dispel' type spell effects \(ie cancel magic\) to be consistent with live

## 01/23/2014

* **Kayen** Implemented SE\_FfLimitUseType \(focus limit to numhits type\)

## 01/20/2014

* **cavedude** Live-Like weather system \(Thanks to robregen for figuring it out!\)
* **mackal** Implemented not\_extendable spell flag
* **mackal** Moved Spell Casting Reinforcement to DB
* **mackal** Moved Mez Mastery to DB
* **Kayen** Complete revision of the numhits systems to utilize 'numhits type' field in spell file.

## 01/18/2014

* **sorvani** Implemented for Lua eq.get\_characters\_in\_instance\(uint16 instance\_id\), return a Lua HashTable
* **mackal** NPCs will now cast their charms.

## 01/13/2014

* **Kayen** Numerous minor fixes to spell effects.
* **Kayen** Changed SE\_ArcheryDoubleAttack -&gt; SE\_DoubleRangedAttack \(now works with throwing ect\)
* **Kayen** Changed SE\_IncreaseHitDmgTaken -&gt; SE\_TriggerMeleeThreshold \(now only works on melee\)
* **Kayen** Changed SE\_MitigateMeleeDamageSP -&gt; SE\_MeleeThresholdGuard
* **Kayen** Implemented SE\_SpellThresholdGuard \(Partial Spell Rune that only is lowered if spell hits are over X amount of damage\)
* **Kayen** Implemented SE\_TriggerSpellThreshold \(implemented  Trigger effect on X amount of spell damage taken\)
* **Kayen** Changed SE\_ReduceHealing -&gt; SE\_FcHealAmtIncoming \(focus limited Add/Remove amount of healing on target by X amount\)
* **Kayen** Change SE\_CriticalHealChance2 -&gt; SE\_CriticalHealDecay
* **Kayen** Change SE\_CriticalHealOverTime2 -&gt; SE\_CriticalRegenDecay
* **Kayen** Implemented SE\_CriticalDotDecay

  Note: 'Decay' effects means the chance to critical decays based on the level of the spell using the effect \(like focus decay\)

* **Kayen** Implemented SE\_FfLimitUseMin \(focus limit to require a min amount of numhits value\)
* **Kayen** Implemented SE\_FcLimitUse \(focus to increases numhits count by percent\)
* **Kayen** Implemented SE\_LimitRace    \(Limits to spells cast by a certain race\)
* **Kayen** Implemented SE\_FcMute  \(silences casting of spells that contain specific spell effects\) ie silence only heals

## 01/09/2014

* **mackal** Add pet size preservation like live \(zone, camp, etc\)

## 01/07/2014

* **mackal** Moved pet can attack check to before it tries to attack, which is more live like.

## 01/03/2014

* **mackal** Crash prevention for emote.

## 01/02/2014

* **mackal** Stuns from beneficial spells \(Harvest\) ignore immunity

